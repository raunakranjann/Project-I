<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Weekly Routine Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
</head>

<body class="bg-gray-100 min-h-screen">

<div class="max-w-7xl mx-auto mt-10 bg-white p-8 rounded-xl shadow">

    <!-- HEADER -->
    <div class="flex justify-between items-center border-b pb-4 mb-6">
        <h2 class="text-2xl font-bold text-gray-800">
            Weekly Routine (Active Semester)
        </h2>
        <a th:href="@{/administration/dashboard}"
           class="bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-800">
            Back
        </a>
    </div>

    <!-- INFO -->
    <div class="mb-4 bg-blue-50 text-blue-700 p-3 rounded text-center font-semibold">
        Routine applies to the <b>currently active semester</b>.
        Semester selection is automatic and read-only.
    </div>

    <!-- FLASH -->
    <div th:if="${success}"
         class="mb-4 bg-green-100 text-green-700 p-3 rounded font-semibold text-center"
         th:text="${success}"></div>

    <div th:if="${error}"
         class="mb-4 bg-red-100 text-red-700 p-3 rounded font-semibold text-center"
         th:text="${error}"></div>

    <!-- ================= MAIN ROUTINE FORM ================= -->
    <form th:action="@{/administration/routine}" method="post">

        <!-- CSRF -->
        <input type="hidden"
               th:name="${_csrf.parameterName}"
               th:value="${_csrf.token}"/>

        <!-- CONTEXT -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <select id="courseSelect" name="courseId" class="input" required>
                <option value="">Select Course</option>
                <option th:each="c : ${courses}"
                        th:value="${c.id}"
                        th:text="${c.code}"></option>
            </select>

            <select id="branchSelect" name="branchId" class="input" required disabled>
                <option value="">Select Branch</option>
            </select>

            <select id="sessionSelect" name="academicSessionId" class="input" required>
                <option value="">Academic Session</option>
                <option th:each="s : ${sessions}"
                        th:value="${s.id}"
                        th:text="${s.displayName}"></option>
            </select>
        </div>

        <!-- ROUTINE GRID -->
        <div id="routineGrid" class="overflow-x-auto opacity-50 pointer-events-none">
            <table class="w-full border text-sm text-center">
                <thead class="bg-gray-100">
                <tr>
                    <th class="border p-2">Day</th>
                    <th th:each="slot : ${timeslots}">
                        Period <span th:text="${slot.periodNo}"></span>
                        <div class="text-xs text-gray-600">
                            <span th:text="${slot.startTime}"></span>
                            -
                            <span th:text="${slot.endTime}"></span>
                        </div>
                    </th>
                </tr>
                </thead>

                <tbody>
                <tr th:each="day, dStat : ${days}">
                    <td class="border p-2 font-semibold" th:text="${day}"></td>

                    <td th:each="p, pStat : ${#numbers.sequence(1, totalPeriods)}"
                        class="border p-2 align-top"
                        th:data-day="${day}"
                        th:data-period="${p}"
                        th:with="idx=${dStat.index * totalPeriods + pStat.index}">

                        <input type="hidden"
                               th:name="|entries[${idx}].day|"
                               th:value="${day}"/>

                        <input type="hidden"
                               th:name="|entries[${idx}].period|"
                               th:value="${p}"/>

                        <select th:name="|entries[${idx}].teacherId|"
                                class="teacher-select w-full border p-1 rounded mb-1">
                            <option value="">Select Teacher</option>
                        </select>

                        <input type="text"
                               th:name="|entries[${idx}].subject|"
                               placeholder="Subject"
                               class="w-full border p-1 rounded"/>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- ACTIONS -->
        <div class="mt-6 flex justify-end gap-4">
            <button type="button"
                    onclick="downloadPdf()"
                    class="bg-red-600 text-white px-5 py-2 rounded font-semibold">
                Download PDF
            </button>

            <button type="submit"
                    class="bg-green-600 text-white px-6 py-2 rounded font-semibold">
                Save Weekly Routine
            </button>
        </div>
    </form>

    <!-- ================= MANUAL GENERATE ================= -->
    <form th:action="@{/administration/routine/generate}"
          method="post"
          class="mt-6 text-right"
          onsubmit="return confirm('Generate classes from updated routine?');">

        <input type="hidden"
               th:name="${_csrf.parameterName}"
               th:value="${_csrf.token}"/>

        <button type="submit"
                class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
            Apply Routine & Generate Classes
        </button>
    </form>

</div>

<style>
    .input {
        width: 100%;
        padding: 10px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
    }
</style>

<script>
    const courseSelect = document.getElementById("courseSelect");
    const branchSelect = document.getElementById("branchSelect");
    const sessionSelect = document.getElementById("sessionSelect");
    const routineGrid = document.getElementById("routineGrid");

    const lockGrid = () => routineGrid.classList.add("opacity-50", "pointer-events-none");
    const unlockGrid = () => routineGrid.classList.remove("opacity-50", "pointer-events-none");

    const clearGrid = () => {
        document.querySelectorAll(".teacher-select").forEach(s =>
            s.innerHTML = "<option value=''>Select Teacher</option>"
        );
        document.querySelectorAll("input[placeholder='Subject']").forEach(i => i.value = "");
    };

    /* COURSE â†’ BRANCH */
    courseSelect.addEventListener("change", () => {
        branchSelect.innerHTML = "<option value=''>Select Branch</option>";
        branchSelect.disabled = true;
        lockGrid();
        clearGrid();

        if (!courseSelect.value) return;

        fetch(`/administration/routine/branches-by-course?courseId=${courseSelect.value}`)
            .then(r => r.json())
            .then(data => {
                data.forEach(b => {
                    const o = document.createElement("option");
                    o.value = b.id;
                    o.textContent = b.code;
                    branchSelect.appendChild(o);
                });
                branchSelect.disabled = false;
            });
    });

    /* LOAD ROUTINE */
    const loadRoutine = () => {
        if (!courseSelect.value || !branchSelect.value || !sessionSelect.value) {
            lockGrid();
            clearGrid();
            return;
        }

        fetch(`/administration/routine/load?courseId=${courseSelect.value}&branchId=${branchSelect.value}&academicSessionId=${sessionSelect.value}`)
            .then(r => r.json())
            .then(data => {
                clearGrid();
                unlockGrid();

                data.forEach(r => {
                    const cell = document.querySelector(
                        `[data-day="${r.dayOfWeek}"][data-period="${r.periodNo}"]`
                    );
                    if (!cell) return;

                    const subjectInput = cell.querySelector("input[placeholder='Subject']");
                    if (subjectInput) subjectInput.value = r.subjectName ?? "";

                    const select = cell.querySelector(".teacher-select");
                    if (select && r.teacher) {
                        const opt = document.createElement("option");
                        opt.value = r.teacher.id;
                        opt.textContent = r.teacher.name;
                        opt.selected = true;
                        select.appendChild(opt);
                    }
                });
            });
    };

    branchSelect.addEventListener("change", loadRoutine);
    sessionSelect.addEventListener("change", loadRoutine);

    /* ===== TEACHER DROPDOWN (CRITICAL) ===== */
    document.addEventListener("focusin", e => {

        if (!e.target.classList.contains("teacher-select")) return;
        if (!courseSelect.value || !branchSelect.value || !sessionSelect.value) return;

        const select = e.target;
        const cell = select.closest("[data-day][data-period]");
        if (!cell) return;

        const day = cell.dataset.day;
        const period = cell.dataset.period;
        const current = select.value;

        fetch(`/administration/routine/available-teachers?day=${day}&period=${period}`)
            .then(r => r.json())
            .then(teachers => {

                select.innerHTML = "<option value=''>Select Teacher</option>";

                teachers.forEach(t => {
                    const opt = document.createElement("option");
                    opt.value = t.id;
                    opt.textContent = t.busy ? `${t.name} (Busy)` : t.name;
                    opt.disabled = t.busy && String(t.id) !== current;
                    opt.selected = String(t.id) === current;
                    select.appendChild(opt);
                });
            });
    });

    function downloadPdf() {
        if (!courseSelect.value || !branchSelect.value || !sessionSelect.value) {
            alert("Select Course, Branch and Session");
            return;
        }
        window.open(
            `/api/administration/routine/pdf?courseId=${courseSelect.value}&branchId=${branchSelect.value}&academicSessionId=${sessionSelect.value}`,
            "_blank"
        );
    }
</script>

</body>
</html>
